'use client';

import React, { useMemo, useState, useCallback } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/registry/new-york-v4/ui/card';
import { BarChart3, ChevronsUpDown } from 'lucide-react';
import {
    CartesianGrid,
    XAxis,
    YAxis,
    Bar,
    Line,
    Area,
    Pie,
    Cell,
    BarChart,
    LineChart,
    AreaChart,
    PieChart,
    ResponsiveContainer,
} from 'recharts';
import {
    ChartContainer,
    ChartTooltip,
    ChartTooltipContent,
    type ChartConfig as ShadChartConfig,
} from '@/registry/new-york-v4/ui/chart';
import { Badge } from '@/registry/new-york-v4/ui/badge';
import { Button } from '@/registry/new-york-v4/ui/button';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/registry/new-york-v4/ui/collapsible';
import { useTranslations } from 'next-intl';

const DEFAULT_CHART_COLORS = [
    'var(--chart-1)',
    'var(--chart-2)',
    'var(--chart-3)',
    'var(--chart-4)',
    'var(--chart-5)',
    'var(--chart-6)',
];

export type ChartResultCardProps = {
    result: ChartResultPart;
    source?: 'tool' | 'auto';
    onFollowUp?: (prompt: string) => void;
};

export type ChartResultPart = {
    type: 'chart';
    chartType: 'bar' | 'line' | 'area' | 'pie';
    title?: string;
    description?: string;
    data: Array<Record<string, unknown>>;
    xKey?: string;
    yKeys?: ChartSeries[];
    categoryKey?: string;
    valueKey?: string;
    options?: {
        stacked?: boolean;
    };
};

type ChartSeries = {
    key: string;
    label?: string;
    color?: string;
};

function buildChartFollowUpPrompt(
    result: ChartResultPart,
    t: (key: string, values?: Record<string, unknown>) => string,
    source?: 'tool' | 'auto',
) {
    const { chartType, title, description, xKey, yKeys, categoryKey, valueKey } = result;

    const lines: string[] = [];
    if (title) lines.push(t('ChartResult.FollowUp.Title', { title }));
    if (description) lines.push(t('ChartResult.FollowUp.Description', { description }));
    lines.push(t('ChartResult.FollowUp.ChartType', { chartType }));

    if (xKey) lines.push(t('ChartResult.FollowUp.XKey', { xKey }));
    if (yKeys && yKeys.length) {
        const yDesc = yKeys
            .map((series) =>
                t('ChartResult.FollowUp.SeriesItem', { label: series.label ?? series.key, key: series.key }),
            )
            .join(t('ChartResult.FollowUp.Separator'));
        lines.push(t('ChartResult.FollowUp.YKeys', { yKeys: yDesc }));
    }
    if (categoryKey) lines.push(t('ChartResult.FollowUp.CategoryKey', { categoryKey }));
    if (valueKey) lines.push(t('ChartResult.FollowUp.ValueKey', { valueKey }));

    if (source === 'auto') lines.push(t('ChartResult.FollowUp.AutoGenerated'));
    return `${t('ChartResult.FollowUp.Prompt')}\n\n${lines.join('\n')}`;
}

function getFirstKey(row?: Record<string, unknown>) {
    if (!row) return undefined;
    const keys = Object.keys(row);
    return keys.length ? keys[0] : undefined;
}

export function ChartResultCard({ result, source = 'tool', onFollowUp }: ChartResultCardProps) {
    const t = useTranslations('DoryUI');
    const { chartType, data, title, description, xKey, yKeys, categoryKey, valueKey, options } = result;

    // ✅ 默认展开策略：Auto 生成的图，默认展开更符合“我帮你画了”的预期
    const [open, setOpen] = useState(source === 'auto');

    const hasData = Array.isArray(data) && data.length > 0;

    const effectiveSeries = useMemo<ChartSeries[]>(() => {
        if (!hasData) return [];

        if (yKeys && yKeys.length > 0) return yKeys;

        // 如果是 pie：更合理的是用 valueKey（或第二列）
        if (valueKey) return [{ key: valueKey, label: valueKey }];

        // fallback：尝试找出除 xKey 外的第一个数值列
        const firstRow = data[0] as Record<string, unknown>;
        const fallbackX = xKey ?? categoryKey ?? getFirstKey(firstRow);
        const keys = Object.keys(firstRow).filter((k) => k !== fallbackX);
        if (keys.length) return [{ key: keys[0], label: keys[0] }];

        return [];
    }, [hasData, yKeys, valueKey, data, xKey, categoryKey]);

    const effectiveXKey = useMemo(() => {
        if (!hasData) return undefined;
        const firstRow = data[0] as Record<string, unknown>;
        return xKey ?? categoryKey ?? getFirstKey(firstRow);
    }, [hasData, data, xKey, categoryKey]);

    const effectiveValueKey = useMemo(() => {
        // pie 主要看 valueKey；其它看 series[0]
        return valueKey ?? effectiveSeries[0]?.key ?? effectiveXKey;
    }, [valueKey, effectiveSeries, effectiveXKey]);

    const chartConfig = useMemo<ShadChartConfig>(() => {
        const cfg: ShadChartConfig = {};
        effectiveSeries.forEach((series, index) => {
            cfg[series.key] = {
                label: series.label ?? series.key,
                color: series.color ?? DEFAULT_CHART_COLORS[index % DEFAULT_CHART_COLORS.length],
            };
        });
        return cfg;
    }, [effectiveSeries]);

    const metaLine = useMemo(() => {
        if (!hasData) return '';
        const pointCount = data.length;
        const seriesCount = chartType === 'pie' ? 1 : Math.max(1, effectiveSeries.length);
        const xLabel = effectiveXKey ? `X: ${String(effectiveXKey)}` : '';
        const sLabel = seriesCount ? t('ChartResult.Meta.Series', { count: seriesCount }) : '';
        const pLabel = t('ChartResult.Meta.Points', { count: pointCount });
        return [xLabel, sLabel, pLabel].filter(Boolean).join(' · ');
    }, [hasData, data.length, chartType, effectiveSeries.length, effectiveXKey, t]);

    const handleFollowUpClick = useCallback(() => {
        if (!onFollowUp) return;
        const prompt = buildChartFollowUpPrompt(result, t as any, source);
        onFollowUp(prompt);
    }, [onFollowUp, result, t, source]);

    if (!hasData) {
        return (
            <Card className="mt-3 border-border/70 bg-muted/20">
                <CardHeader className="py-3">
                    <CardTitle className="text-sm font-medium flex items-center gap-2">
                        <BarChart3 className="h-4 w-4 text-muted-foreground" />
                        {title ?? t('ChartResult.Title')}
                        {source === 'auto' && (
                            <Badge variant="outline" className="ml-1 text-[11px]">
                                {t('ChartResult.AutoGenerated')}
                            </Badge>
                        )}
                    </CardTitle>
                </CardHeader>
                <CardContent className="pt-0 pb-4">
                    <div className="rounded-md border border-border/60 bg-background/50 px-3 py-2 text-sm text-muted-foreground">
                        {t('ChartResult.NoData')}
                    </div>
                </CardContent>
            </Card>
        );
    }

    const renderChart = () => {
        // ✅ 统一：容器高度固定，避免 layout 抖动
        const containerClass = 'min-h-[240px] w-full';

        // ✅ 对缺轴给出更明确错误
        if (chartType !== 'pie' && (!effectiveXKey || effectiveSeries.length === 0)) {
            return <div className="text-sm text-muted-foreground">{t('ChartResult.Errors.MissingAxis')}</div>;
        }

        if (chartType === 'pie') {
            const pieCategoryKey = categoryKey ?? effectiveXKey;
            const pieValueKey = effectiveValueKey;

            if (!pieCategoryKey || !pieValueKey) {
                return <div className="text-sm text-muted-foreground">{t('ChartResult.Errors.MissingPieKeys')}</div>;
            }

            return (
                <ChartContainer
                    // pie 的 config 主要用于 tooltip label/颜色体系；这里保持最小配置
                    config={{
                        [String(pieValueKey)]: {
                            label: effectiveSeries[0]?.label ?? String(pieValueKey),
                            color: effectiveSeries[0]?.color ?? DEFAULT_CHART_COLORS[0],
                        },
                    }}
                    className={containerClass}
                >
                    <ResponsiveContainer width="100%" height={240}>
                        <PieChart>
                            <ChartTooltip content={<ChartTooltipContent nameKey={String(pieCategoryKey)} />} />
                            <Pie
                                data={data as Array<Record<string, any>>}
                                dataKey={String(pieValueKey)}
                                nameKey={String(pieCategoryKey)}
                                innerRadius={42}
                                outerRadius={92}
                                paddingAngle={3}
                                stroke="transparent"
                            >
                                {(data as Array<Record<string, any>>).map((_, index) => (
                                    <Cell key={index} fill={DEFAULT_CHART_COLORS[index % DEFAULT_CHART_COLORS.length]} />
                                ))}
                            </Pie>
                        </PieChart>
                    </ResponsiveContainer>
                </ChartContainer>
            );
        }

        if (chartType === 'bar') {
            return (
                <ChartContainer config={chartConfig} className={containerClass}>
                    <ResponsiveContainer width="100%" height={260}>
                        <BarChart data={data} barSize={22} margin={{ left: 4, right: 12, top: 8, bottom: 0 }}>
                            <CartesianGrid vertical={false} />
                            <XAxis dataKey={String(effectiveXKey)} tickLine={false} axisLine={false} tickMargin={8} />
                            <YAxis tickLine={false} axisLine={false} width={36} />
                            <ChartTooltip content={<ChartTooltipContent />} />
                            {effectiveSeries.map((series) => (
                                <Bar
                                    key={series.key}
                                    dataKey={series.key}
                                    fill={`var(--color-${series.key})`}
                                    radius={4}
                                    stackId={options?.stacked ? 'stack' : undefined}
                                />
                            ))}
                        </BarChart>
                    </ResponsiveContainer>
                </ChartContainer>
            );
        }

        if (chartType === 'line') {
            return (
                <ChartContainer config={chartConfig} className={containerClass}>
                    <ResponsiveContainer width="100%" height={260}>
                        <LineChart data={data} margin={{ left: 4, right: 12, top: 8, bottom: 0 }}>
                            <CartesianGrid strokeDasharray="4 4" />
                            <XAxis dataKey={String(effectiveXKey)} tickLine={false} axisLine={false} tickMargin={8} />
                            <YAxis tickLine={false} axisLine={false} width={36} />
                            <ChartTooltip content={<ChartTooltipContent indicator="line" />} />
                            {effectiveSeries.map((series) => (
                                <Line
                                    key={series.key}
                                    type="monotone"
                                    dataKey={series.key}
                                    stroke={`var(--color-${series.key})`}
                                    strokeWidth={2}
                                    dot={false}
                                    activeDot={{ r: 4 }}
                                />
                            ))}
                        </LineChart>
                    </ResponsiveContainer>
                </ChartContainer>
            );
        }

        // area
        return (
            <ChartContainer config={chartConfig} className={containerClass}>
                <ResponsiveContainer width="100%" height={260}>
                    <AreaChart data={data} margin={{ left: 4, right: 12, top: 8, bottom: 0 }}>
                        <CartesianGrid strokeDasharray="4 4" />
                        <XAxis dataKey={String(effectiveXKey)} tickLine={false} axisLine={false} tickMargin={8} />
                        <YAxis tickLine={false} axisLine={false} width={36} />
                        <ChartTooltip content={<ChartTooltipContent />} />
                        {effectiveSeries.map((series) => (
                            <Area
                                key={series.key}
                                type="monotone"
                                dataKey={series.key}
                                stroke={`var(--color-${series.key})`}
                                fill={`var(--color-${series.key})`}
                                fillOpacity={0.18}
                                stackId={options?.stacked ? 'stack' : undefined}
                            />
                        ))}
                    </AreaChart>
                </ResponsiveContainer>
            </ChartContainer>
        );
    };

    return (
        <Collapsible open={open} onOpenChange={setOpen} className="mt-3">
            <Card className="border-border/70 bg-muted/20 py-0">
                <CardHeader className="py-3">
                    <div className="flex items-start justify-between gap-3">
                        <div className="min-w-0">
                            <CardTitle className="text-sm font-medium flex items-center gap-2">
                                <BarChart3 className="h-4 w-4 text-muted-foreground" />
                                <span className="truncate">{title ?? t('ChartResult.Title')}</span>
                                {source === 'auto' && (
                                    <Badge variant="outline" className="text-[11px]">
                                        {t('ChartResult.AutoGenerated')}
                                    </Badge>
                                )}
                            </CardTitle>

                            {/* ✅ meta 行：把“这张图是什么”说清楚，但不打扰 */}
                            <div className="mt-1 text-xs text-muted-foreground">
                                {metaLine}
                            </div>

                            {/* description 更像“附注”，只在展开时显示 */}
                            {description && open && (
                                <div className="mt-1 text-xs text-muted-foreground">
                                    {description}
                                </div>
                            )}
                        </div>

                        <div className="flex items-center gap-1.5">
                            {onFollowUp && (
                                <Button
                                    type="button"
                                    size="sm"
                                    variant="ghost"
                                    className="h-7 px-2 text-xs"
                                    onClick={handleFollowUpClick}
                                >
                                    {t('ChartResult.FollowUp.Button')}
                                </Button>
                            )}

                            <CollapsibleTrigger asChild>
                                <Button
                                    type="button"
                                    size="icon"
                                    variant="ghost"
                                    className="h-7 w-7"
                                    aria-label={open ? t('ChartResult.Collapse') : t('ChartResult.Expand')}
                                >
                                    <ChevronsUpDown className="h-4 w-4" />
                                </Button>
                            </CollapsibleTrigger>
                        </div>
                    </div>
                </CardHeader>

                <CollapsibleContent>
                    <CardContent className="pt-0 pb-4">
                        {renderChart()}
                    </CardContent>
                </CollapsibleContent>
            </Card>
        </Collapsible>
    );
}
